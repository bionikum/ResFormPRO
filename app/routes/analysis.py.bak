from flask import Blueprint, request, jsonify, current_app
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
import os
from datetime import datetime
import threading
from app import db
from app.models import PostureAnalysis

analysis_bp = Blueprint('analysis', __name__)

# Конфигурация загрузки файлов
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg'}

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@analysis_bp.route('/upload', methods=['POST'])
@login_required
def upload_images():
    """Упрощенная загрузка фотографий для анализа"""
    try:
        # Создание папки для пользователя
        user_folder = os.path.join(
            current_app.config['UPLOAD_FOLDER'],
            str(current_user.id),
            datetime.now().strftime('%Y%m%d_%H%M%S')
        )
        os.makedirs(user_folder, exist_ok=True)
        
        # Ожидаемые ракурсы
        views = ['front', 'side', 'back', 'face']
        uploaded_files = {}
        
        # Обработка каждого файла
        for view in views:
            file_key = f'{view}_image'
            
            if file_key not in request.files:
                return jsonify({'error': f'Отсутствует фото: {view}'}), 400
            
            file = request.files[file_key]
            
            if file.filename == '':
                return jsonify({'error': f'Не выбрано фото для: {view}'}), 400
            
            if not allowed_file(file.filename):
                return jsonify({'error': f'Недопустимый формат файла для: {view}'}), 400
            
            # Сохранение файла
            filename = secure_filename(f"{view}_{file.filename}")
            filepath = os.path.join(user_folder, filename)
            file.save(filepath)
            
            uploaded_files[view] = filepath
        
        # Создание записи в БД
        analysis = PostureAnalysis(
            user_id=current_user.id,
            front_image=uploaded_files.get('front'),
            side_image=uploaded_files.get('side'),
            back_image=uploaded_files.get('back'),
            face_image=uploaded_files.get('face'),
            analysis_date=datetime.utcnow(),
            overall_score=75.0,  # Заглушка
            is_completed=True    # Для теста сразу завершаем
        )
        
        db.session.add(analysis)
        db.session.commit()
        
        # Тестовые результаты
        test_results = {
            'summary': {'average_score': 80, 'views_analyzed': 4},
            'recommendations': ['Упражнения для осанки', 'Растяжка грудного отдела'],
            'status': 'completed'
        }
        
        analysis.set_analysis_results(test_results)
        db.session.commit()
        
        return jsonify({
            'success': True,
            'message': 'Фотографии загружены. Анализ завершен.',
            'analysis_id': analysis.id,
            'results': test_results
        })
        
    except Exception as e:
        current_app.logger.error(f'Ошибка загрузки: {str(e)}')
        return jsonify({'error': 'Внутренняя ошибка сервера'}), 500

@analysis_bp.route('/analysis/<int:analysis_id>', methods=['GET'])
@login_required
def get_analysis(analysis_id):
    """Получение результатов анализа"""
    analysis = PostureAnalysis.query.get_or_404(analysis_id)
    
    # Проверка прав доступа
    if analysis.user_id != current_user.id and current_user.role not in ['admin', 'specialist']:
        return jsonify({'error': 'Доступ запрещен'}), 403
    
    results = analysis.get_analysis_results()
    
    return jsonify({
        'status': 'completed',
        'analysis_id': analysis.id,
        'date': analysis.analysis_date.isoformat(),
        'score': analysis.overall_score,
        'results': results
    })

@analysis_bp.route('/test', methods=['GET'])
def test_endpoint():
    """Тестовый endpoint"""
    return jsonify({
        'status': 'success',
        'message': 'Analysis module is working',
        'timestamp': datetime.now().isoformat()
    })

@analysis_bp.route('/upload-page')
@login_required
def upload_images_page():
    """HTML страница для загрузки фотографий"""
    return '''
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Загрузка фотографий - ResFormPRO</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
            body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
            .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .card-header { background-color: #81C784; color: white; }
            .btn-success { background-color: #66BB6A; border-color: #66BB6A; }
            .pose-img { max-height: 200px; object-fit: contain; }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container">
                <a class="navbar-brand text-success" href="/">
                    <i class="fas fa-heartbeat me-2"></i>ResFormPRO
                </a>
            </div>
        </nav>
        
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h4 class="mb-0">
                                <i class="fas fa-camera me-2"></i>Загрузка фотографий для анализа
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h5><i class="fas fa-info-circle me-2"></i>Инструкция:</h5>
                                <ul class="mb-0">
                                    <li>Сделайте 4 фотографии согласно примерам ниже</li>
                                    <li>Формат: JPG или PNG</li>
                                    <li>Максимальный размер: 20MB</li>
                                    <li>Носите обтягивающую одежду для лучшего анализа</li>
                                </ul>
                            </div>
                            
                            <form id="uploadForm" enctype="multipart/form-data" onsubmit="uploadPhotos(event)">
                                <div class="row">
                                    {% for view in ['front', 'side', 'back', 'face'] %}
                                    <div class="col-md-6 mb-4">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <h5 class="card-title text-success">
                                                    <i class="fas fa-user me-2"></i>
                                                    {% if view == 'front' %}Тело спереди
                                                    {% elif view == 'side' %}Тело сбоку
                                                    {% elif view == 'back' %}Тело сзади
                                                    {% else %}Лицо спереди{% endif %}
                                                </h5>
                                                <div class="mb-3">
                                                    <div class="bg-light rounded p-3">
                                                        <i class="fas fa-image fa-4x text-secondary"></i>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <input type="file" 
                                                           class="form-control" 
                                                           id="{{ view }}_image" 
                                                           name="{{ view }}_image"
                                                           accept="image/*"
                                                           required>
                                                    <small class="form-text text-muted">
                                                        {% if view == 'front' %}Стойте прямо, руки вдоль тела
                                                        {% elif view == 'side' %}Повернитесь левым боком
                                                        {% elif view == 'back' %}Спина к камере
                                                        {% else %}Смотрите прямо в камеру{% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn">
                                        <i class="fas fa-play-circle me-2"></i>Начать анализ
                                    </button>
                                </div>
                            </form>
                            
                            <div class="mt-4" id="result" style="display: none;">
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-check-circle me-2"></i>Анализ завершен!</h5>
                                    <div id="resultContent"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        async function uploadPhotos(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Обработка...';
            
            try {
                const response = await fetch('/analysis/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('resultContent').innerHTML = `
                        <p>${result.message}</p>
                        <p><strong>ID анализа:</strong> ${result.analysis_id}</p>
                        <div class="mt-3">
                            <h6>Результаты:</h6>
                            <p>Средний балл: ${result.results.summary.average_score}</p>
                            <p>Проанализировано ракурсов: ${result.results.summary.views_analyzed}</p>
                            <p>Рекомендации:</p>
                            <ul>
                                ${result.results.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Ошибка сети: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        </script>
    </body>
    </html>
    '''
