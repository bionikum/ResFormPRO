from flask import render_template, jsonify, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app import db
from app.models import PostureAnalysis, User, Recommendation
from . import main

@main.route('/')
def index():
    """Главная страница"""
    if current_user.is_authenticated:
        return redirect(url_for('main.dashboard'))
    return render_template('index.html')

@main.route('/dashboard')
@login_required
def dashboard():
    """Панель управления пользователя"""
    # Получаем анализы пользователя
    user_analyses = PostureAnalysis.query.filter_by(
        user_id=current_user.id
    ).order_by(PostureAnalysis.analysis_date.desc()).limit(10).all()
    
    # Статистика
    total_analyses = PostureAnalysis.query.filter_by(
        user_id=current_user.id
    ).count()
    
    completed_analyses = PostureAnalysis.query.filter_by(
        user_id=current_user.id,
        is_completed=True
    ).count()
    
    # Средний балл
    scores_query = db.session.query(db.func.avg(PostureAnalysis.overall_score)).filter(
        PostureAnalysis.user_id == current_user.id,
        PostureAnalysis.overall_score.isnot(None)
    ).scalar()
    
    average_score = float(scores_query) if scores_query else 0
    
    # Активные рекомендации
    active_recommendations = Recommendation.query.filter_by(
        user_id=current_user.id,
        is_completed=False
    ).order_by(Recommendation.created_at.desc()).limit(3).all()
    
    return render_template('dashboard.html',
                         user_analyses=user_analyses,
                         total_analyses=total_analyses,
                         completed_analyses=completed_analyses,
                         average_score=average_score,
                         active_recommendations=active_recommendations)

@main.route('/health')
def health():
    """Проверка здоровья приложения"""
    try:
        # Проверка БД
        db.session.execute('SELECT 1')
        db_status = 'healthy'
    except Exception as e:
        db_status = f'unhealthy: {str(e)}'
    
    health_data = {
        'status': 'healthy',
        'service': 'ResFormPRO',
        'database': db_status,
        'timestamp': datetime.utcnow().isoformat()
    }
    
    return jsonify(health_data)

@main.route('/profile')
@login_required
def profile():
    """Страница профиля пользователя"""
    return render_template('profile.html', user=current_user)

@main.route('/profile/update', methods=['POST'])
@login_required
def update_profile():
    """Обновление профиля пользователя"""
    try:
        full_name = request.form.get('full_name')
        if full_name:
            current_user.full_name = full_name
        
        db.session.commit()
        flash('Профиль успешно обновлен', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Ошибка при обновлении профиля: {str(e)}', 'error')
    
    return redirect(url_for('main.profile'))

@main.route('/subscription')
@login_required
def subscription():
    """Страница подписки"""
    return render_template('subscription.html', user=current_user)

@main.route('/analyses')
@login_required
def analyses_list():
    """Список всех анализов пользователя"""
    page = request.args.get('page', 1, type=int)
    per_page = 10
    
    analyses = PostureAnalysis.query.filter_by(
        user_id=current_user.id
    ).order_by(PostureAnalysis.analysis_date.desc()).paginate(
        page=page, per_page=per_page, error_out=False
    )
    
    return render_template('analyses/list.html', analyses=analyses)

@main.route('/analysis/<int:analysis_id>')
@login_required
def analysis_detail(analysis_id):
    """Детальная страница анализа"""
    analysis = PostureAnalysis.query.get_or_404(analysis_id)
    
    # Проверка прав доступа
    if analysis.user_id != current_user.id and not current_user.is_admin():
        flash('У вас нет доступа к этому анализу', 'error')
        return redirect(url_for('main.dashboard'))
    
    # Получение рекомендаций для этого анализа
    recommendations = Recommendation.query.filter_by(
        analysis_id=analysis_id
    ).order_by(Recommendation.created_at.desc()).all()
    
    return render_template('analyses/detail.html', 
                         analysis=analysis, 
                         recommendations=recommendations)

@main.route('/progress')
@login_required
def progress():
    """Страница прогресса"""
    # Получаем все завершенные анализы с оценками
    completed_analyses = PostureAnalysis.query.filter_by(
        user_id=current_user.id,
        is_completed=True
    ).filter(
        PostureAnalysis.overall_score.isnot(None)
    ).order_by(PostureAnalysis.analysis_date.asc()).all()
    
    # Подготавливаем данные для графика
    chart_data = {
        'dates': [],
        'scores': [],
        'labels': []
    }
    
    for analysis in completed_analyses:
        chart_data['dates'].append(analysis.analysis_date.strftime('%d.%m.%Y'))
        chart_data['scores'].append(analysis.overall_score)
        chart_data['labels'].append(f'Анализ {analysis.id}')
    
    return render_template('progress.html', 
                         chart_data=chart_data,
                         analyses=completed_analyses)

@main.route('/api/stats')
@login_required
def api_stats():
    """API для получения статистики (для AJAX)"""
    # Анализы по месяцам
    from datetime import datetime, timedelta
    from sqlalchemy import extract
    
    # За последние 6 месяцев
    six_months_ago = datetime.utcnow() - timedelta(days=180)
    
    monthly_stats = db.session.query(
        extract('month', PostureAnalysis.analysis_date).label('month'),
        extract('year', PostureAnalysis.analysis_date).label('year'),
        db.func.count(PostureAnalysis.id).label('count')
    ).filter(
        PostureAnalysis.user_id == current_user.id,
        PostureAnalysis.analysis_date >= six_months_ago
    ).group_by(
        extract('year', PostureAnalysis.analysis_date),
        extract('month', PostureAnalysis.analysis_date)
    ).order_by('year', 'month').all()
    
    # Форматируем данные
    stats = {
        'monthly': [
            {
                'month': f"{int(stat.month):02d}.{int(stat.year)}",
                'count': stat.count
            }
            for stat in monthly_stats
        ],
        'total_analyses': PostureAnalysis.query.filter_by(
            user_id=current_user.id
        ).count(),
        'average_score': db.session.query(
            db.func.avg(PostureAnalysis.overall_score)
        ).filter(
            PostureAnalysis.user_id == current_user.id,
            PostureAnalysis.overall_score.isnot(None)
        ).scalar() or 0
    }
    
    return jsonify(stats)

@main.route('/help')
def help_page():
    """Страница помощи"""
    return render_template('help.html')

@main.route('/about')
def about():
    """Страница о проекте"""
    return render_template('about.html')

@main.route('/terms')
def terms():
    """Условия использования"""
    return render_template('terms.html')

@main.route('/privacy')
def privacy():
    """Политика конфиденциальности"""
    return render_template('privacy.html')

# Обработчики ошибок
@main.app_errorhandler(404)
def page_not_found(e):
    return render_template('errors/404.html'), 404

@main.app_errorhandler(500)
def internal_server_error(e):
    return render_template('errors/500.html'), 500

@main.app_errorhandler(403)
def forbidden(e):
    return render_template('errors/403.html'), 403
